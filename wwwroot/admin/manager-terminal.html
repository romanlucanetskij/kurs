<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Terminal | DRIP CUBE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body,
        html {
            margin: 0;
            width: 100%;
            height: 100%;
            font-family: 'JetBrains Mono';
            background: #050505;
            color: #ccc;
            overflow: hidden;
        }


        .grid-lines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .line-v {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: rgba(0, 255, 0, 0.05);
        }

        .l1 {
            left: 30%;
        }



        .nav-back {
            position: fixed;
            top: 20px;
            right: 20px;
            text-decoration: none;
            color: #666;
            border: 1px solid #333;
            padding: 5px 15px;
            font-size: 12px;
            z-index: 100;
            transition: 0.3s;
        }

        .nav-back:hover {
            color: #fff;
            border-color: #fff;
        }


        .terminal-layout {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 10;
        }


        .chat-list-panel {
            width: 30%;
            border-right: 1px solid #333;
            background: rgba(10, 10, 10, 0.5);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 20px;
            background: #000;
            border-bottom: 1px solid #333;
            color: #0f0;
            font-weight: bold;
            text-transform: uppercase;
        }

        .chats-scroll {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px 20px;
            border-bottom: 1px solid #222;
            cursor: pointer;
            transition: 0.2s;
        }

        .chat-item:hover {
            background: #111;
            border-left: 3px solid #0f0;
        }

        .chat-item.active {
            background: #1a1a1a;
            border-left: 3px solid #0f0;
            color: #fff;
        }

        .c-user {
            font-weight: bold;
            font-size: 14px;
            color: #fff;
        }

        .c-last {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        .chat-window {
            width: 70%;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
        }

        #chat-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: 20px;
        }

        #active-chat-view {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .messages-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .msg {
            max-width: 60%;
            padding: 10px 15px;
            font-size: 14px;
            border: 1px solid #333;
        }

        .msg-user {
            align-self: flex-start;
            border-color: #fff;
            background: #111;
            color: #fff;
        }

        .msg-manager {
            align-self: flex-end;
            border-color: #0f0;
            background: #051a05;
            color: #0f0;
            text-align: right;
        }

        .msg-info {
            font-size: 9px;
            opacity: 0.5;
            margin-bottom: 5px;
        }


        .input-area {
            padding: 20px;
            border-top: 1px solid #333;
            background: #000;
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 15px;
            font-family: 'JetBrains Mono';
            outline: none;
        }

        input:focus {
            border-color: #0f0;
        }

        button {
            padding: 0 30px;
            background: #0f0;
            color: #000;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-family: 'JetBrains Mono';
        }

        button:hover {
            background: #fff;
        }
    </style>
</head>

<body>

    <div class="grid-lines">
        <div class="line-v l1"></div>
    </div>
    <a href="/account/profile.html" class="nav-back">LOGOUT</a>

    <div class="terminal-layout">

        <div class="chat-list-panel">
            <div class="panel-header">Active Signals</div>
            <div class="chats-scroll" id="chats-list">
            </div>
        </div>

        <div class="chat-window">
            <div id="chat-placeholder">// SELECT SIGNAL TO DECRYPT //</div>

            <div id="active-chat-view">
                <div class="panel-header" id="current-user-name">USER: ---</div>
                <div class="messages-area" id="messages-area"></div>
                <div class="input-area">
                    <input type="text" id="msg-input" placeholder="Type response...">
                    <button onclick="sendReply()">SEND</button>
                </div>
            </div>
        </div>

    </div>

    <script>

        const API_URL = 'http://localhost:5182/api/chats';

        const manager = JSON.parse(localStorage.getItem('drip_user'));


        if (!manager || manager.role !== 'Manager') {
            alert("ACCESS DENIED");
            window.location.href = '/account/profile.html';
        }

        let currentSessionId = null;
        let pollingInterval = null;


        async function loadChats() {
            try {

                const res = await fetch(`${API_URL}/manager-chats/${manager.id}`);
                const chats = await res.json();

                renderChatList(chats);
            } catch (e) { console.error(e); }
        }

        function renderChatList(chats) {
            const list = document.getElementById('chats-list');
            list.innerHTML = '';

            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = `chat-item ${chat.sessionId === currentSessionId ? 'active' : ''}`;
                div.onclick = () => openChat(chat.sessionId, chat.userName);

                div.innerHTML = `
                    <div class="c-user">USER: ${chat.userName}</div>
                    <div class="c-last">> ${chat.lastMessage}</div>
                `;
                list.appendChild(div);
            });
        }


        function openChat(sessionId, userName) {
            currentSessionId = sessionId;
            document.getElementById('chat-placeholder').style.display = 'none';
            document.getElementById('active-chat-view').style.display = 'flex';
            document.getElementById('current-user-name').innerText = `Target: ${userName}`;

            loadMessages();
            loadChats();


            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(loadMessages, 2000);
        }


        async function loadMessages() {
            if (!currentSessionId) return;
            const area = document.getElementById('messages-area');

            try {
                const res = await fetch(`${API_URL}/history/${currentSessionId}`);
                const messages = await res.json();

                area.innerHTML = '';
                messages.forEach(m => {
                    const div = document.createElement('div');

                    const typeClass = m.sender === 'User' ? 'msg-user' : 'msg-manager';

                    div.className = `msg ${typeClass}`;
                    div.innerHTML = `
                        <div class="msg-info">${m.sender}</div>
                        <div>${m.text}</div>
                    `;
                    area.appendChild(div);
                });

            } catch (e) { console.error(e); }
        }


        async function sendReply() {
            const input = document.getElementById('msg-input');
            const text = input.value;
            if (!text || !currentSessionId) return;

            try {
                await fetch(`${API_URL}/send-manager`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: currentSessionId,

                        senderId: "00000000-0000-0000-0000-000000000000",
                        text: text
                    })
                });

                input.value = '';
                loadMessages();

            } catch (e) { alert("Error"); }
        }


        loadChats();

        setInterval(loadChats, 5000);

    </script>
</body>

</html>